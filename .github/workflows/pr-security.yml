name: PR Security

# PRä½œæˆãƒ»æ›´æ–°æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ
# ç›®çš„: npm auditè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'tests/e2e/**'  # E2Eãƒ†ã‚¹ãƒˆã¯åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å®Ÿè¡Œ

# æ¨©é™è¨­å®š
permissions:
  contents: read
  pull-requests: write
  checks: write

# åŒã˜PRã‹ã‚‰ã®è¤‡æ•°å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: pr-security-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # npm auditã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: Cache npm audit results
      uses: actions/cache@v4
      with:
        path: |
          audit-results.json
        key: audit-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          audit-cache-${{ runner.os }}-

    - name: Install dependencies (with retry)
      run: |
        # retryæ©Ÿèƒ½ä»˜ãã®npm install
        for i in {1..3}; do
          echo "Attempt $i: Installing dependencies..."
          npm ci --prefer-offline --silent --no-audit --no-fund && break
          echo "Install failed. Waiting 30 seconds before retry..."
          sleep 30
        done

    # npm auditã«ã‚ˆã‚‹è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
    - name: Security Vulnerability Scan
      run: |
        echo "## ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY

        # npm auditã‚’JSONã§å®Ÿè¡Œã—ã€é«˜ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
        npm audit --json > audit-results.json 2>/dev/null || true

        # jqã‚’ä½¿ã£ã¦high/criticalè„†å¼±æ€§ã‚’æŠ½å‡º
        high_critical_count=$(jq '.vulnerabilities | to_entries[] | select(.value.severity=="high" or .value.severity=="critical") | .key' audit-results.json 2>/dev/null | wc -l || echo "0")

        # è©³ç´°æƒ…å ±ã‚’step summaryã«è¿½åŠ 
        total_vulnerabilities=$(jq '.metadata.vulnerabilities | .info + .low + .moderate + .high + .critical' audit-results.json 2>/dev/null || echo "0")
        echo "**Total vulnerabilities found:** $total_vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "**High/Critical vulnerabilities:** $high_critical_count" >> $GITHUB_STEP_SUMMARY

        # é«˜ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã®ã¿å¤±æ•—
        if [ "$high_critical_count" -gt 0 ]; then
          echo "âŒ é«˜ãƒªã‚¹ã‚¯ã¾ãŸã¯ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªè„†å¼±æ€§ãŒ $high_critical_count ä»¶ç™ºè¦‹ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          jq -r '.vulnerabilities | to_entries[] | select(.value.severity=="high" or .value.severity=="critical")' audit-results.json >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼ˆé«˜ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ãªã—ï¼‰" >> $GITHUB_STEP_SUMMARY

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
    - name: Security Features Test
      run: npm run ci:security
