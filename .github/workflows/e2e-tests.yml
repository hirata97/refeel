name: E2E Tests

# E2Eテスト専用ワークフロー
on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'e2e/**'
      - 'package*.json'
      - 'vite.config.ts'
      - 'playwright.config.ts'
  
  # 手動実行も可能
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser to test on'
        required: false
        default: 'chromium'
        type: choice
        options:
        - chromium
        - firefox
        - webkit
        - all

# 権限設定
permissions:
  contents: read
  pull-requests: write
  checks: write

# 同じPRからの複数実行をキャンセル
concurrency:
  group: e2e-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  e2e-tests:
    name: E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        browser: 
          - chromium
          - firefox
          - webkit
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline --silent
      
    # Playwrightブラウザのインストール
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps ${{ matrix.browser }}
      
    # アプリケーションビルド
    - name: Build application
      run: npm run build
      
    # E2Eテスト実行
    - name: Run E2E tests
      run: npx playwright test --project=${{ matrix.browser }}
      env:
        CI: true
        
    # テスト結果のアーティファクト保存
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-report-${{ matrix.browser }}
        path: |
          playwright-report/
          test-results/
        retention-days: 7
        
    # スクリーンショット保存（失敗時）
    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: e2e-screenshots-${{ matrix.browser }}
        path: test-results/
        retention-days: 3

  # E2Eテスト結果サマリー
  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    
    steps:
    - name: Generate E2E Summary
      uses: actions/github-script@v7
      with:
        script: |
          const browsers = ['chromium', 'firefox', 'webkit'];
          const results = {};
          
          browsers.forEach(browser => {
            const jobResult = '${{ needs.e2e-tests.result }}';
            results[browser] = jobResult;
          });
          
          let summary = '## 🎭 E2E Test Results\n\n';
          summary += '| Browser | Status |\n';
          summary += '|---------|--------|\n';
          
          Object.entries(results).forEach(([browser, result]) => {
            const icon = result === 'success' ? '✅' : 
                        result === 'failure' ? '❌' : '⚠️';
            summary += `| ${browser} | ${icon} ${result} |\n`;
          });
          
          const allPassed = Object.values(results).every(r => r === 'success');
          
          if (!allPassed) {
            summary += '\n⚠️ 一部のE2Eテストが失敗しています。詳細はArtifactsを確認してください。\n';
          } else {
            summary += '\n🎉 すべてのE2Eテストが成功しました！\n';
          }
          
          summary += '\n### 📊 詳細レポート\n';
          summary += `- 📋 [Playwright Report](${context.payload.pull_request?.html_url}/checks)\n`;
          summary += '- 📸 スクリーンショット（失敗時のみ）: Artifacts参照\n';
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  # パフォーマンステスト
  performance:
    name: Performance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline --silent
      
    - name: Build application
      run: npm run build
      
    # Lighthouse CI
    - name: Lighthouse CI
      uses: treosh/lighthouse-ci-action@v12
      with:
        configPath: './.lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN || '' }}
        
    # バンドルサイズ監視
    - name: Bundle Size Check
      run: |
        npm run build
        
        # 主要チャンクのサイズチェック
        MAIN_JS_SIZE=$(ls -la dist/index-*.js | awk '{print $5}')
        MAIN_CSS_SIZE=$(ls -la dist/index-*.css | awk '{print $5}')
        
        echo "## 📦 Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "| Asset | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Main JS | ${MAIN_JS_SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
        echo "| Main CSS | ${MAIN_CSS_SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
        
        # 1MB制限チェック
        if [ "$MAIN_JS_SIZE" -gt 1048576 ]; then
          echo "❌ JSバンドルサイズが1MBを超えています: $MAIN_JS_SIZE bytes"
          exit 1
        fi
        
        echo "✅ バンドルサイズチェック完了"