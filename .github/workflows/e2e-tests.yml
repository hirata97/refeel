name: E2E Tests

# E2Eテスト専用ワークフロー - 3階層テスト戦略
# Tier 1 (Smoke): 全PR、chromiumのみ、5分以内
# Tier 2 (Core): 手動実行、chromium+firefox、15分以内
# Tier 3 (Full): ready-to-mergeラベル、全ブラウザ、30分以内
on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'e2e/**'
      - 'package*.json'
      - 'vite.config.ts'
      - 'playwright.config.ts'
      - '.github/workflows/e2e-tests.yml'

  # 手動実行も可能
  workflow_dispatch:
    inputs:
      tier:
        description: 'Test tier to run'
        required: false
        default: 'smoke'
        type: choice
        options:
        - smoke
        - core
        - full
      browser:
        description: 'Browser to test on (for core/full tiers)'
        required: false
        default: 'chromium'
        type: choice
        options:
        - chromium
        - firefox
        - webkit
        - all

# 権限設定
permissions:
  contents: read
  pull-requests: write
  checks: write

# 同じPRからの複数実行をキャンセル
concurrency:
  group: e2e-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Tier 1: スモークテスト（全PR、chromiumのみ、5分以内）
  smoke-tests:
    name: E2E Smoke Tests (Tier 1)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request' || github.event.inputs.tier == 'smoke'
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline --silent

    # Playwrightブラウザのインストール（chromiumのみ）
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    # Supabase CLIのセットアップ
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    # Supabase Localの起動
    - name: Start Supabase Local
      run: supabase start

    # Supabase起動完了待機（ヘルスチェック）
    - name: Wait for Supabase services
      run: |
        echo "Waiting for Supabase services to be ready..."
        MAX_ATTEMPTS=30
        ATTEMPT=0

        # Step 1: Wait for supabase status to succeed
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          if supabase status > /dev/null 2>&1; then
            echo "✅ Supabase CLI reports services are running"
            supabase status
            break
          fi

          ATTEMPT=$((ATTEMPT + 1))
          echo "⏳ Attempt $ATTEMPT/$MAX_ATTEMPTS: Supabase not ready yet, waiting..."
          sleep 2
        done

        if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
          echo "❌ ERROR: Supabase failed to start within timeout"
          exit 1
        fi

        # Step 2: Wait for Supabase API to be responsive
        echo "Checking Supabase API health at http://127.0.0.1:54321..."
        ATTEMPT=0

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          if curl -f http://127.0.0.1:54321/rest/v1/ > /dev/null 2>&1; then
            echo "✅ Supabase API is responsive and ready!"
            break
          fi

          ATTEMPT=$((ATTEMPT + 1))
          echo "⏳ Attempt $ATTEMPT/$MAX_ATTEMPTS: API not ready yet, waiting..."
          sleep 2
        done

        if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
          echo "❌ ERROR: Supabase API failed to become responsive"
          exit 1
        fi

        echo "🎉 All Supabase services are ready!"

    # アプリケーションビルド（Supabase環境変数を使用）
    - name: Build application
      run: npm run build
      env:
        VITE_SUPABASE_URL: http://127.0.0.1:54321
        VITE_SUPABASE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0

    # スモークテスト実行（chromiumのみ、smoke/配下のみ）
    - name: Run Smoke Tests
      run: npx playwright test --project=chromium e2e/smoke
      env:
        CI: true
        E2E_TIER: smoke
        VITE_SUPABASE_URL: http://127.0.0.1:54321
        VITE_SUPABASE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0

    # テスト結果のアーティファクト保存
    - name: Upload smoke test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-report
        path: |
          playwright-report/
          test-results/
        retention-days: 7

    # スクリーンショット保存（失敗時）
    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: smoke-test-screenshots
        path: test-results/
        retention-days: 3

  # Tier 2: コア機能テスト（手動実行、chromium+firefox、15分以内）
  core-tests:
    name: E2E Core Tests (Tier 2 - ${{ matrix.browser }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.inputs.tier == 'core' || github.event.inputs.tier == 'full'

    strategy:
      fail-fast: false
      matrix:
        browser:
          - chromium
          - firefox

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline --silent

    # Playwrightブラウザのインストール
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps ${{ matrix.browser }}

    # アプリケーションビルド
    - name: Build application
      run: npm run build

    # コア機能テスト実行（core/配下のみ）
    - name: Run Core Feature Tests
      run: npx playwright test --project=${{ matrix.browser }} e2e/core
      env:
        CI: true
        E2E_TIER: core

    # テスト結果のアーティファクト保存
    - name: Upload core test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: core-test-report-${{ matrix.browser }}
        path: |
          playwright-report/
          test-results/
        retention-days: 7

    # スクリーンショット保存（失敗時）
    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: core-test-screenshots-${{ matrix.browser }}
        path: test-results/
        retention-days: 3

  # Tier 3: フルテスト（ready-to-mergeラベル、全ブラウザ、30分以内）
  full-tests:
    name: E2E Full Tests (Tier 3 - ${{ matrix.browser }})
    runs-on: ubuntu-latest
    timeout-minutes: 35
    if: |
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'ready-to-merge')) ||
      github.event.inputs.tier == 'full'

    strategy:
      fail-fast: false
      matrix:
        browser:
          - chromium
          - firefox
          - webkit

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline --silent

    # Playwrightブラウザのインストール
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps ${{ matrix.browser }}

    # アプリケーションビルド
    - name: Build application
      run: npm run build

    # フルE2Eテスト実行（全テスト）
    - name: Run Full E2E Tests
      run: npx playwright test --project=${{ matrix.browser }}
      env:
        CI: true
        E2E_TIER: full

    # テスト結果のアーティファクト保存
    - name: Upload full test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: full-test-report-${{ matrix.browser }}
        path: |
          playwright-report/
          test-results/
        retention-days: 7

    # スクリーンショット保存（失敗時）
    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: full-test-screenshots-${{ matrix.browser }}
        path: test-results/
        retention-days: 3

  # E2Eテスト結果サマリー
  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [smoke-tests, core-tests, full-tests]
    if: always() && github.event_name == 'pull_request'

    steps:
    - name: Generate E2E Summary
      uses: actions/github-script@v7
      with:
        script: |
          const smokeResult = '${{ needs.smoke-tests.result }}';
          const coreResult = '${{ needs.core-tests.result }}';
          const fullResult = '${{ needs.full-tests.result }}';

          let summary = '## 🎭 E2E Test Results (Tiered Strategy)\n\n';

          // Tier 1: Smoke Tests (always runs on PRs)
          summary += '### Tier 1: Smoke Tests (Critical Path)\n';
          summary += '| Test Tier | Browser | Status |\n';
          summary += '|-----------|---------|--------|\n';
          const smokeIcon = smokeResult === 'success' ? '✅' :
                           smokeResult === 'failure' ? '❌' :
                           smokeResult === 'skipped' ? '⏭️' : '⚠️';
          summary += `| Smoke | chromium | ${smokeIcon} ${smokeResult} |\n\n`;

          // Tier 2: Core Tests (manual or specific triggers)
          if (coreResult !== 'skipped') {
            summary += '### Tier 2: Core Feature Tests\n';
            summary += '| Test Tier | Browsers | Status |\n';
            summary += '|-----------|----------|--------|\n';
            const coreIcon = coreResult === 'success' ? '✅' :
                            coreResult === 'failure' ? '❌' : '⚠️';
            summary += `| Core | chromium, firefox | ${coreIcon} ${coreResult} |\n\n`;
          }

          // Tier 3: Full Tests (ready-to-merge label)
          if (fullResult !== 'skipped') {
            summary += '### Tier 3: Full E2E Tests\n';
            summary += '| Test Tier | Browsers | Status |\n';
            summary += '|-----------|----------|--------|\n';
            const fullIcon = fullResult === 'success' ? '✅' :
                            fullResult === 'failure' ? '❌' : '⚠️';
            summary += `| Full | chromium, firefox, webkit | ${fullIcon} ${fullResult} |\n\n`;
          }

          // Overall status
          const criticalPass = smokeResult === 'success';

          if (!criticalPass) {
            summary += '\n❌ **スモークテストが失敗しています。** クリティカルパスに問題があります。\n';
          } else {
            summary += '\n✅ **スモークテストが成功しました！** 基本的な機能は正常に動作しています。\n';

            if (fullResult === 'skipped' && coreResult === 'skipped') {
              summary += '\n💡 **ヒント:** フルテストを実行するには `ready-to-merge` ラベルを付けてください。\n';
            }
          }

          summary += '\n### 📊 詳細レポート\n';
          summary += `- 📋 [Playwright Report](${context.payload.pull_request?.html_url}/checks)\n`;
          summary += '- 📸 スクリーンショット（失敗時のみ）: Artifacts参照\n';
          summary += '\n### 🎯 E2Eテスト階層化戦略\n';
          summary += '- **Tier 1 (Smoke):** 全PR、chromiumのみ、5分以内\n';
          summary += '- **Tier 2 (Core):** 手動実行、chromium+firefox、15分以内\n';
          summary += '- **Tier 3 (Full):** ready-to-mergeラベル、全ブラウザ、30分以内\n';

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  # パフォーマンステスト（フルテスト時のみ実行）
  performance:
    name: Performance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: full-tests
    if: needs.full-tests.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline --silent
      
    - name: Build application
      run: npm run build
      
    # Lighthouse CI
    - name: Lighthouse CI
      uses: treosh/lighthouse-ci-action@v12
      with:
        configPath: './.lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN || '' }}
        
    # バンドルサイズ監視
    - name: Bundle Size Check
      run: |
        npm run build
        
        # 主要チャンクのサイズチェック
        MAIN_JS_SIZE=$(ls -la dist/index-*.js | awk '{print $5}')
        MAIN_CSS_SIZE=$(ls -la dist/index-*.css | awk '{print $5}')
        
        echo "## 📦 Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "| Asset | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Main JS | ${MAIN_JS_SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
        echo "| Main CSS | ${MAIN_CSS_SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
        
        # 1MB制限チェック
        if [ "$MAIN_JS_SIZE" -gt 1048576 ]; then
          echo "❌ JSバンドルサイズが1MBを超えています: $MAIN_JS_SIZE bytes"
          exit 1
        fi
        
        echo "✅ バンドルサイズチェック完了"