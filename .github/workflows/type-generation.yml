# TypeScriptå‹å®šç¾©è‡ªå‹•ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Issue #144å¯¾å¿œ: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰TypeScriptå‹å®šç¾©ã®è‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½

name: Type Generation

on:
  push:
    branches: [ main ]
    paths:
      - 'database/migrations/**'
      - '.github/workflows/type-generation.yml'
      - 'scripts/generate-types.js'
  pull_request:
    branches: [ main ]
    paths:
      - 'database/migrations/**'
      - '.github/workflows/type-generation.yml'
      - 'scripts/generate-types.js'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

jobs:
  generate-types:
    name: Generate TypeScript Types
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate types (production)
        run: npm run generate-types:prod
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Check for type changes
        id: type-changes
        run: |
          if git diff --quiet src/types/; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Run type check
        run: npm run ci:type-check

      - name: Run affected tests
        run: npm run test:unit -- --run tests/types/

      - name: Commit generated types (main branch only)
        if: steps.type-changes.outputs.changed == 'true' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add src/types/
          git commit -m "chore: update TypeScript type definitions from database schema

          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>" || exit 0

      - name: Push changes (main branch only)
        if: steps.type-changes.outputs.changed == 'true' && github.ref == 'refs/heads/main'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

  validate-types:
    name: Validate Type Definitions
    runs-on: ubuntu-latest
    needs: generate-types

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate types for validation
        run: npm run generate-types

      - name: Run comprehensive type check
        run: npm run ci:type-check

      - name: Run build test
        run: npm run ci:build

      - name: Run unit tests
        run: npm run ci:test

      - name: Type definition validation
        run: |
          echo "Validating generated type definitions..."
          
          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "src/types/database.ts" ]; then
            echo "âŒ database.ts not found"
            exit 1
          fi
          
          if [ ! -f "src/types/supabase.ts" ]; then
            echo "âŒ supabase.ts not found"  
            exit 1
          fi
          
          echo "âœ… All type definition files exist"
          
          # å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æ¤œè¨¼
          grep -q "export interface Database" src/types/database.ts || (echo "âŒ Database interface not found" && exit 1)
          grep -q "export type DiaryEntry" src/types/supabase.ts || (echo "âŒ DiaryEntry type not found" && exit 1)
          
          echo "âœ… Type definitions validated successfully"