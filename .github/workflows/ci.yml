name: Quality Check CI

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '*.md'

jobs:
  # åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯
  lint-and-format:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline
      
    - name: Run ESLint
      run: npm run ci:lint
      continue-on-error: true
      
    - name: Check Prettier formatting
      run: npm run format -- --check
      continue-on-error: true

  # TypeScriptå‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã¨ã—ã¦æ‰±ã†ï¼‰
  type-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline
      
    - name: TypeScript check
      run: npm run ci:type-check
      continue-on-error: true

  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  unit-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline
      
    - name: Run unit tests
      run: npm run ci:test
      continue-on-error: true
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: coverage/
        retention-days: 3

  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [lint-and-format, type-check]
    if: always()
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline
      
    - name: Build application
      run: npm run build
      
    - name: Check build artifacts
      run: |
        ls -la dist/
        echo "Build completed successfully"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
  security-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline
      
    - name: Security audit
      run: npm run ci:security
      continue-on-error: true

  # CIçµæœã‚µãƒãƒªãƒ¼
  ci-summary:
    runs-on: ubuntu-latest
    needs: [lint-and-format, type-check, unit-tests, build-check, security-audit]
    if: always() && github.event_name == 'pull_request'
    
    steps:
    - name: CI Summary Comment
      uses: actions/github-script@v7
      with:
        script: |
          const results = {
            'Lint & Format': '${{ needs.lint-and-format.result }}',
            'TypeScript Check': '${{ needs.type-check.result }}',
            'Unit Tests': '${{ needs.unit-tests.result }}',
            'Build Check': '${{ needs.build-check.result }}',
            'Security Audit': '${{ needs.security-audit.result }}'
          };
          
          let summary = '## ğŸ¤– CI Pipeline Results\n\n';
          
          Object.entries(results).forEach(([check, result]) => {
            const icon = result === 'success' ? 'âœ…' : 
                        result === 'failure' ? 'âŒ' : 'âš ï¸';
            summary += `${icon} **${check}**: ${result}\n`;
          });
          
          summary += '\n> ç¾åœ¨ã®CIè¨­å®šã§ã¯ä¸€éƒ¨ã®ãƒã‚§ãƒƒã‚¯ã¯è­¦å‘Šã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚';
          summary += '\n> æ®µéšçš„ã«å“è³ªã‚’å‘ä¸Šã•ã›ã¦ã„ãã¾ã™ã€‚';
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });