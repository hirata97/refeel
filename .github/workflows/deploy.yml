name: Deploy to Production

# ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'tests/**'
      - 'e2e/**'

# æ¨©é™è¨­å®š
permissions:
  contents: read
  deployments: write
  statuses: write

# åŒæ™‚ãƒ‡ãƒ—ãƒ­ã‚¤é˜²æ­¢
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # äº‹å‰å“è³ªãƒã‚§ãƒƒã‚¯
  pre-deploy-check:
    name: Pre-deployment Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      deploy-ready: ${{ steps.quality-check.outputs.ready }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline --silent
      
    # æœ€çµ‚å“è³ªãƒã‚§ãƒƒã‚¯
    - name: Final Quality Check
      id: quality-check
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å‰å“è³ªãƒã‚§ãƒƒã‚¯é–‹å§‹..."
        
        # ESLint
        if ! npm run ci:lint; then
          echo "âŒ ESLintã‚¨ãƒ©ãƒ¼ã‚ã‚Š - ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­æ­¢"
          echo "ready=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # TypeScript
        if ! npm run ci:type-check; then
          echo "âŒ TypeScriptã‚¨ãƒ©ãƒ¼ã‚ã‚Š - ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­æ­¢"
          echo "ready=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
        if ! npm run ci:build; then
          echo "âŒ ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚ã‚Š - ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­æ­¢"
          echo "ready=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        if ! npm run ci:security; then
          echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã‚ã‚Š - ç¶™ç¶š"
        fi
        
        echo "âœ… å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº† - ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†"
        echo "ready=true" >> $GITHUB_OUTPUT

  # Vercelã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: needs.pre-deploy-check.outputs.deploy-ready == 'true'
    timeout-minutes: 15
    
    environment:
      name: production
      url: ${{ steps.deploy.outputs.preview-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline --silent
      
    # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
    - name: Production Build
      run: npm run build
      env:
        NODE_ENV: production
        
    # Vercelãƒ‡ãƒ—ãƒ­ã‚¤
    - name: Deploy to Vercel
      id: deploy
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
        
    # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
    - name: Post-deploy Smoke Test
      run: |
        DEPLOY_URL="${{ steps.deploy.outputs.preview-url }}"
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹: $DEPLOY_URL"
        
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        for i in {1..5}; do
          if curl -sSf "$DEPLOY_URL" > /dev/null; then
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç¢ºèªå®Œäº†"
            break
          fi
          echo "â³ è©¦è¡Œ $i/5 - 10ç§’å¾…æ©Ÿ..."
          sleep 10
        done
        
        # ä¸»è¦ãƒšãƒ¼ã‚¸ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
        curl -sSf "$DEPLOY_URL" | grep -q "æ—¥è¨˜ã‚¢ãƒ—ãƒª" || {
          echo "âŒ ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®å†…å®¹ç¢ºèªå¤±æ•—"
          exit 1
        }
        
        echo "âœ… ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆå®Œäº†"

  # ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥
  deploy-notification:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, deploy-vercel]
    if: always()
    
    steps:
    - name: Deployment Status Notification
      uses: actions/github-script@v7
      with:
        script: |
          const preDeployResult = '${{ needs.pre-deploy-check.result }}';
          const deployResult = '${{ needs.deploy-vercel.result }}';
          
          let summary = '## ğŸš€ Production Deployment Status\n\n';
          
          if (preDeployResult !== 'success') {
            summary += 'âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤å‰å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—**\n';
            summary += 'å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ãªã„ãŸã‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãŒä¸­æ­¢ã•ã‚Œã¾ã—ãŸã€‚\n\n';
          } else if (deployResult === 'success') {
            summary += 'âœ… **ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ**\n\n';
            summary += '### ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±\n';
            summary += '- ğŸŒ **URL**: https://goal-categorization-diary.vercel.app\n';
            summary += '- â° **ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»**: ' + new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'}) + '\n';
            summary += '- ğŸ“¦ **ã‚³ãƒŸãƒƒãƒˆ**: ' + context.sha.substring(0, 7) + '\n\n';
            summary += '### âœ… å®Œäº†ã—ãŸå“è³ªãƒã‚§ãƒƒã‚¯\n';
            summary += '- ESLint: é€šé\n';
            summary += '- TypeScript: é€šé\n'; 
            summary += '- ãƒ“ãƒ«ãƒ‰: æˆåŠŸ\n';
            summary += '- ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ: æˆåŠŸ\n';
          } else {
            summary += 'âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—**\n\n';
            summary += 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n';
            summary += 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n';
          }
          
          // GitHub Deployment APIä½¿ç”¨
          if (deployResult === 'success') {
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              auto_merge: false,
              required_contexts: []
            });
          }
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number || 0,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });