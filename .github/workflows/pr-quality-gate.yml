name: PR Quality Gate

# PRä½œæˆãƒ»æ›´æ–°æ™‚ã®å³æ ¼ãªå“è³ªãƒã‚§ãƒƒã‚¯
on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'e2e/**'  # E2Eãƒ†ã‚¹ãƒˆã¯åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å®Ÿè¡Œ

# æ¨©é™è¨­å®š
permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

# åŒã˜PRã‹ã‚‰ã®è¤‡æ•°å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: pr-quality-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Stage 1: åŸºæœ¬å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆé«˜é€Ÿãƒ»å³æ ¼ï¼‰
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ã‚³ãƒŸãƒƒãƒˆå±¥æ­´å…¨ä½“ã‚’å–å¾—
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies (with retry)
      run: |
        # retryæ©Ÿèƒ½ä»˜ãã®npm install
        for i in {1..3}; do
          echo "Attempt $i: Installing dependencies..."
          npm ci --prefer-offline --silent --no-audit --no-fund && break
          echo "Install failed. Waiting 30 seconds before retry..."
          sleep 30
        done
      
    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          dist
          node_modules/.vite
        key: build-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          build-cache-${{ runner.os }}-
        
    # å³æ ¼ãªESLintãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ï¼‰
    - name: ESLint Code Analysis
      run: npm run ci:lint
      
    # å³æ ¼ãªTypeScriptãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ï¼‰
    - name: TypeScript Type Check
      run: npm run ci:type-check
      
    # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    - name: Prettier Format Check
      run: npx prettier --check src/
      
    # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    - name: Production Build Test
      run: npm run ci:build
      
    - name: Check Build Artifacts
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
        # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ index.htmlãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
        echo "âœ… ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®æ¤œè¨¼å®Œäº†"
        
    # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æ
    - name: Bundle Size Analysis
      run: |
        echo "## ğŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        ls -lah dist/*.js | head -10 >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY

  # Stage 2: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆä¸¦è¡Œå®Ÿè¡Œï¼‰
  testing:
    name: Comprehensive Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    strategy:
      matrix:
        node-version: [18, 20]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies (with retry)
      run: |
        # retryæ©Ÿèƒ½ä»˜ãã®npm install
        for i in {1..3}; do
          echo "Attempt $i: Installing dependencies..."
          npm ci --prefer-offline --silent --no-audit --no-fund && break
          echo "Install failed. Waiting 30 seconds before retry..."
          sleep 30
        done
      
    # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãï¼‰
    - name: Run Unit Tests with Coverage
      run: npm run ci:test
      
    # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: Coverage Report
      uses: codecov/codecov-action@v4
      if: matrix.node-version == 20
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: unit-tests-coverage
        fail_ci_if_error: false
        
    # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
    - name: Coverage Threshold Check
      if: matrix.node-version == 20
      run: |
        echo "## ğŸ“Š Coverage Threshold Check" >> $GITHUB_STEP_SUMMARY

        # coverage-summary.jsonã‹ã‚‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        if [ -f "coverage/coverage-summary.json" ]; then
          # jqã‚’ä½¿ã£ã¦å„ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æŠ½å‡º
          lines=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
          statements=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
          functions=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
          branches=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)

          echo "**ã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°:**" >> $GITHUB_STEP_SUMMARY
          echo "- Lines: $lines%" >> $GITHUB_STEP_SUMMARY
          echo "- Statements: $statements%" >> $GITHUB_STEP_SUMMARY
          echo "- Functions: $functions%" >> $GITHUB_STEP_SUMMARY
          echo "- Branches: $branches%" >> $GITHUB_STEP_SUMMARY

          # æ¨å¥¨é–¾å€¤: 70% (è­¦å‘Šã®ã¿ã€å¤±æ•—ã•ã›ãªã„)
          RECOMMENDED_THRESHOLD=70

          # è­¦å‘Šåˆ¤å®šï¼ˆæ¨å¥¨ãƒ¬ãƒ™ãƒ«ï¼‰
          if (( $(echo "$lines < $RECOMMENDED_THRESHOLD" | bc -l) )); then
            echo "âš ï¸ **è­¦å‘Š**: Lines coverage ($lines%) ãŒæ¨å¥¨å€¤ ($RECOMMENDED_THRESHOLD%) ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Lines coverage ($lines%) is below recommended threshold ($RECOMMENDED_THRESHOLD%)"
          else
            echo "âœ… Lines coverage ã¯æ¨å¥¨å€¤ã‚’æº€ãŸã—ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ³¨æ„**: ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ã¯æ¨å¥¨ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚å¤±æ•—æ¡ä»¶ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi

  # Stage 3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies (with retry)
      run: |
        # retryæ©Ÿèƒ½ä»˜ãã®npm install
        for i in {1..3}; do
          echo "Attempt $i: Installing dependencies..."
          npm ci --prefer-offline --silent --no-audit --no-fund && break
          echo "Install failed. Waiting 30 seconds before retry..."
          sleep 30
        done
      
    # npm auditã«ã‚ˆã‚‹è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
    - name: Security Vulnerability Scan
      run: |
        echo "## ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY

        # npm auditã‚’JSONã§å®Ÿè¡Œã—ã€é«˜ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
        npm audit --json > audit-results.json 2>/dev/null || true

        # jqã‚’ä½¿ã£ã¦high/criticalè„†å¼±æ€§ã‚’æŠ½å‡º
        high_critical_count=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity=="high" or .value.severity=="critical") | .key' audit-results.json 2>/dev/null | wc -l || echo "0")

        # è©³ç´°æƒ…å ±ã‚’step summaryã«è¿½åŠ 
        total_vulnerabilities=$(jq -r '.metadata.vulnerabilities | .info + .low + .moderate + .high + .critical' audit-results.json 2>/dev/null || echo "0")
        echo "**Total vulnerabilities found:** $total_vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "**High/Critical vulnerabilities:** $high_critical_count" >> $GITHUB_STEP_SUMMARY

        # é«˜ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã®ã¿å¤±æ•—
        if [ "$high_critical_count" -gt 0 ]; then
          echo "âŒ é«˜ãƒªã‚¹ã‚¯ã¾ãŸã¯ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªè„†å¼±æ€§ãŒ $high_critical_count ä»¶ç™ºè¦‹ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "```json" >> $GITHUB_STEP_SUMMARY
          jq -r '.vulnerabilities | to_entries[] | select(.value.severity=="high" or .value.severity=="critical")' audit-results.json >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼ˆé«˜ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ãªã—ï¼‰" >> $GITHUB_STEP_SUMMARY
        
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
    - name: Security Features Test
      run: npm run ci:security
      
  # Stage 4: çµ±åˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆ
  quality-report:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [code-quality, testing, security]
    if: always()
    
    steps:
    - name: Generate Quality Report
      uses: actions/github-script@v7
      with:
        script: |
          const codeQualityResult = '${{ needs.code-quality.result }}';
          const testingResult = '${{ needs.testing.result }}';
          const securityResult = '${{ needs.security.result }}';

          // å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸã‹åˆ¤å®š
          const allPassed = codeQualityResult === 'success' &&
                           testingResult === 'success' &&
                           securityResult === 'success';

          const status = allPassed ? 'âœ… å“è³ªã‚²ãƒ¼ãƒˆé€šé' : 'âŒ å“è³ªã‚²ãƒ¼ãƒˆå¤±æ•—';

          // çµæœã‚¢ã‚¤ã‚³ãƒ³ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
          const getIcon = (result) => {
            if (result === 'success') return 'âœ…';
            if (result === 'failure') return 'âŒ';
            if (result === 'skipped') return 'â­ï¸';
            return 'âš ï¸';
          };

          let report = `## ${status}\n\n`;
          report += '### ğŸ“Š ãƒã‚§ãƒƒã‚¯çµæœ\n\n';
          report += `${getIcon(codeQualityResult)} **Code Quality**: ${codeQualityResult}\n`;
          report += `${getIcon(testingResult)} **Testing**: ${testingResult}\n`;
          report += `${getIcon(securityResult)} **Security**: ${securityResult}\n`;

          report += '\n### ğŸ“‹ å“è³ªåŸºæº–\n';
          report += '#### å¿…é ˆãƒ¬ãƒ™ãƒ«ï¼ˆPRãƒãƒ¼ã‚¸æ¡ä»¶ï¼‰\n';
          report += '- âœ… **ESLint**: ã‚¨ãƒ©ãƒ¼0ä»¶å¿…é ˆï¼ˆè­¦å‘Šã¯è¨±å®¹ï¼‰\n';
          report += '- âœ… **TypeScript**: å‹ã‚¨ãƒ©ãƒ¼0ä»¶å¿…é ˆ\n';
          report += '- âœ… **Prettier**: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæº–æ‹ å¿…é ˆ\n';
          report += '- âœ… **ãƒ“ãƒ«ãƒ‰**: æœ¬ç•ªãƒ“ãƒ«ãƒ‰æˆåŠŸå¿…é ˆ\n';
          report += '- âœ… **ãƒ†ã‚¹ãƒˆ**: å…¨ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæˆåŠŸå¿…é ˆ\n';
          report += '- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: High/Criticalè„†å¼±æ€§0ä»¶å¿…é ˆ\n\n';

          report += '#### æ¨å¥¨ãƒ¬ãƒ™ãƒ«ï¼ˆè­¦å‘Šè¡¨ç¤ºï¼‰\n';
          report += '- ğŸ“Š **ã‚«ãƒãƒ¬ãƒƒã‚¸**: 70%ä»¥ä¸Šæ¨å¥¨ï¼ˆç¾åœ¨ç›£è¦–ä¸­ï¼‰\n';
          report += '- ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Moderateä»¥ä¸‹ã®è„†å¼±æ€§å¯¾å¿œæ¨å¥¨\n\n';

          if (!allPassed) {
            report += '### âš ï¸ ãƒãƒ¼ã‚¸å‰ã«ä¸Šè¨˜ã®å•é¡Œã‚’è§£æ±ºã—ã¦ãã ã•ã„\n\n';
            report += '#### å¤±æ•—ã—ãŸãƒã‚§ãƒƒã‚¯è©³ç´°\n';
            if (codeQualityResult !== 'success') {
              report += '- **Code Quality**: ESLintã€TypeScriptã€ã¾ãŸã¯ãƒ“ãƒ«ãƒ‰ã«å•é¡ŒãŒã‚ã‚Šã¾ã™\n';
            }
            if (testingResult !== 'success') {
              report += '- **Testing**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã¾ã™\n';
            }
            if (securityResult !== 'success') {
              report += '- **Security**: é«˜ãƒªã‚¹ã‚¯ä»¥ä¸Šã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™\n';
            }
            core.setFailed('å“è³ªã‚²ãƒ¼ãƒˆã®åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“');
          } else {
            report += '### ğŸ‰ ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¦ã„ã¾ã™ï¼\n';
            report += '\nå®‰å¿ƒã—ã¦ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼\n';
          }

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });