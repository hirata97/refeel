name: PR Quality Gate

# PRä½œæˆãƒ»æ›´æ–°æ™‚ã®å³æ ¼ãªå“è³ªãƒã‚§ãƒƒã‚¯
on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'e2e/**'  # E2Eãƒ†ã‚¹ãƒˆã¯åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å®Ÿè¡Œ

# æ¨©é™è¨­å®š
permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

# åŒã˜PRã‹ã‚‰ã®è¤‡æ•°å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: pr-quality-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Stage 1: åŸºæœ¬å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆé«˜é€Ÿãƒ»å³æ ¼ï¼‰
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ã‚³ãƒŸãƒƒãƒˆå±¥æ­´å…¨ä½“ã‚’å–å¾—
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies (with retry)
      run: |
        # retryæ©Ÿèƒ½ä»˜ãã®npm install
        for i in {1..3}; do
          echo "Attempt $i: Installing dependencies..."
          npm ci --prefer-offline --silent --no-audit --no-fund && break
          echo "Install failed. Waiting 30 seconds before retry..."
          sleep 30
        done
      
    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          dist
          node_modules/.vite
        key: build-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          build-cache-${{ runner.os }}-
        
    # å³æ ¼ãªESLintãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ï¼‰
    - name: ESLint Code Analysis
      run: npm run ci:lint
      
    # å³æ ¼ãªTypeScriptãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ï¼‰
    - name: TypeScript Type Check
      run: npm run ci:type-check
      
    # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    - name: Prettier Format Check
      run: npx prettier --check src/
      
    # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    - name: Production Build Test
      run: npm run ci:build
      
    - name: Check Build Artifacts
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
        # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ index.htmlãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
        echo "âœ… ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®æ¤œè¨¼å®Œäº†"
        
    # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æ
    - name: Bundle Size Analysis
      run: |
        echo "## ğŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        ls -lah dist/*.js | head -10 >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY

  # Stage 2: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆä¸¦è¡Œå®Ÿè¡Œï¼‰
  testing:
    name: Comprehensive Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    strategy:
      matrix:
        node-version: [18, 20]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies (with retry)
      run: |
        # retryæ©Ÿèƒ½ä»˜ãã®npm install
        for i in {1..3}; do
          echo "Attempt $i: Installing dependencies..."
          npm ci --prefer-offline --silent --no-audit --no-fund && break
          echo "Install failed. Waiting 30 seconds before retry..."
          sleep 30
        done
      
    # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãï¼‰
    - name: Run Unit Tests with Coverage
      run: npm run ci:test
      
    # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: Coverage Report
      uses: codecov/codecov-action@v4
      if: matrix.node-version == 20
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: unit-tests-coverage
        fail_ci_if_error: false
        
    # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
    - name: Coverage Threshold Check
      if: matrix.node-version == 20
      run: |
        echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ã¯ç¾åœ¨ã‚¹ã‚­ãƒƒãƒ—ä¸­"
        # TODO: ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¾Œã§å®Ÿè£…

  # Stage 3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies (with retry)
      run: |
        # retryæ©Ÿèƒ½ä»˜ãã®npm install
        for i in {1..3}; do
          echo "Attempt $i: Installing dependencies..."
          npm ci --prefer-offline --silent --no-audit --no-fund && break
          echo "Install failed. Waiting 30 seconds before retry..."
          sleep 30
        done
      
    # npm auditã«ã‚ˆã‚‹è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
    - name: Security Vulnerability Scan
      run: |
        echo "## ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY

        # npm auditã‚’JSONã§å®Ÿè¡Œã—ã€é«˜ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
        npm audit --json > audit-results.json 2>/dev/null || true

        # jqã‚’ä½¿ã£ã¦high/criticalè„†å¼±æ€§ã‚’æŠ½å‡º
        high_critical_count=$(jq -r '.vulnerabilities | to_entries[] | select(.value.severity=="high" or .value.severity=="critical") | .key' audit-results.json 2>/dev/null | wc -l || echo "0")

        # è©³ç´°æƒ…å ±ã‚’step summaryã«è¿½åŠ 
        total_vulnerabilities=$(jq -r '.metadata.vulnerabilities | .info + .low + .moderate + .high + .critical' audit-results.json 2>/dev/null || echo "0")
        echo "**Total vulnerabilities found:** $total_vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "**High/Critical vulnerabilities:** $high_critical_count" >> $GITHUB_STEP_SUMMARY

        # é«˜ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã®ã¿å¤±æ•—
        if [ "$high_critical_count" -gt 0 ]; then
          echo "âŒ é«˜ãƒªã‚¹ã‚¯ã¾ãŸã¯ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªè„†å¼±æ€§ãŒ $high_critical_count ä»¶ç™ºè¦‹ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "```json" >> $GITHUB_STEP_SUMMARY
          jq -r '.vulnerabilities | to_entries[] | select(.value.severity=="high" or .value.severity=="critical")' audit-results.json >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼ˆé«˜ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ãªã—ï¼‰" >> $GITHUB_STEP_SUMMARY
        
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
    - name: Security Features Test
      run: npm run ci:security
      
  # Stage 4: çµ±åˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆ
  quality-report:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [code-quality]
    if: always()
    
    steps:
    - name: Generate Quality Report
      uses: actions/github-script@v7
      with:
        script: |
          const codeQualityResult = '${{ needs.code-quality.result }}';
          const allPassed = codeQualityResult === 'success';
          const status = allPassed ? 'âœ… å“è³ªã‚²ãƒ¼ãƒˆé€šé' : 'âŒ å“è³ªã‚²ãƒ¼ãƒˆå¤±æ•—';
          
          let report = `## ${status}\n\n`;
          report += '### ğŸ“Š ãƒã‚§ãƒƒã‚¯çµæœ\n\n';
          report += `âœ… **Code Quality**: ${codeQualityResult}\n`;
          
          report += '\n### ğŸ“‹ å“è³ªåŸºæº–\n';
          report += '- âœ… ESLint: ã‚¨ãƒ©ãƒ¼0ä»¶å¿…é ˆ\n';
          report += '- âœ… TypeScript: å‹ã‚¨ãƒ©ãƒ¼0ä»¶å¿…é ˆ\n';
          report += '- âœ… Prettier: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæº–æ‹ \n';
          report += '- âœ… ãƒ“ãƒ«ãƒ‰: æˆåŠŸå¿…é ˆ\n\n';
          
          if (!allPassed) {
            report += '### âš ï¸ ãƒãƒ¼ã‚¸å‰ã«ä¸Šè¨˜ã®å•é¡Œã‚’è§£æ±ºã—ã¦ãã ã•ã„\n';
            core.setFailed('å“è³ªã‚²ãƒ¼ãƒˆã®åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“');
          } else {
            report += '### ğŸ‰ ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¦ã„ã¾ã™ï¼\n';
          }
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });