name: PR Code Quality

# PRä½œæˆãƒ»æ›´æ–°æ™‚ã®ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
# ç›®çš„: ESLintã€TypeScriptã€Prettierã€ãƒ“ãƒ«ãƒ‰ã®åŽ³æ ¼ãªæ¤œè¨¼
on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'tests/e2e/**'  # E2Eãƒ†ã‚¹ãƒˆã¯åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å®Ÿè¡Œ

# æ¨©é™è¨­å®š
permissions:
  contents: read
  pull-requests: write
  checks: write

# åŒã˜PRã‹ã‚‰ã®è¤‡æ•°å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: pr-code-quality-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ã‚³ãƒŸãƒƒãƒˆå±¥æ­´å…¨ä½“ã‚’å–å¾—

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # TypeScriptå¢—åˆ†ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: Cache TypeScript build info
      uses: actions/cache@v4
      with:
        path: |
          tsconfig.tsbuildinfo
          node_modules/.cache
        key: ts-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**/*.ts', 'src/**/*.vue') }}
        restore-keys: |
          ts-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
          ts-cache-${{ runner.os }}-

    # ESLintã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: Cache ESLint
      uses: actions/cache@v4
      with:
        path: .eslintcache
        key: eslint-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**/*.ts', 'src/**/*.vue', 'eslint.config.js') }}
        restore-keys: |
          eslint-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
          eslint-cache-${{ runner.os }}-

    # Viteãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: Cache Vite build
      uses: actions/cache@v4
      with:
        path: |
          dist
          node_modules/.vite
        key: vite-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**/*', 'vite.config.ts') }}
        restore-keys: |
          vite-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
          vite-cache-${{ runner.os }}-

    - name: Install dependencies (with retry)
      run: |
        # retryæ©Ÿèƒ½ä»˜ãã®npm install
        for i in {1..3}; do
          echo "Attempt $i: Installing dependencies..."
          npm ci --prefer-offline --silent --no-audit --no-fund && break
          echo "Install failed. Waiting 30 seconds before retry..."
          sleep 30
        done

    # åŽ³æ ¼ãªESLintãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰
    - name: ESLint Code Analysis
      run: npx eslint . --max-warnings=0 --cache --cache-location .eslintcache --config config/eslint.config.js

    # åŽ³æ ¼ãªTypeScriptãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ï¼‰
    - name: TypeScript Type Check
      run: npm run ci:type-check

    # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    - name: Prettier Format Check
      run: npx prettier --check src/

    # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    - name: Production Build Test
      run: npm run ci:build

    - name: Check Build Artifacts
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi

        # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ index.htmlãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi

        echo "âœ… ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã®æ¤œè¨¼å®Œäº†"

    # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æž
    - name: Bundle Size Analysis
      run: |
        echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        ls -lah dist/*.js | head -10 >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
