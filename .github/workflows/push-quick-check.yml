name: Push Quick Check

# main/developãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã®è»½é‡å“è³ªãƒã‚§ãƒƒã‚¯
# ç›®çš„: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€å°é™ã®å“è³ªç¢ºèªï¼ˆESLintã€TypeScriptã€ãƒ“ãƒ«ãƒ‰ï¼‰
on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

# æ¨©é™è¨­å®š
permissions:
  contents: read
  checks: write

# åŒã˜ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®è¤‡æ•°å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: push-quick-check-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quick-check:
    name: Quick Check (Push)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # ESLintã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: Cache ESLint
      uses: actions/cache@v4
      with:
        path: .eslintcache
        key: eslint-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**/*.ts', 'src/**/*.vue', 'eslint.config.js') }}
        restore-keys: |
          eslint-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
          eslint-cache-${{ runner.os }}-

    # TypeScriptå¢—åˆ†ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: Cache TypeScript build info
      uses: actions/cache@v4
      with:
        path: |
          tsconfig.tsbuildinfo
          node_modules/.cache
        key: ts-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**/*.ts', 'src/**/*.vue') }}
        restore-keys: |
          ts-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
          ts-cache-${{ runner.os }}-

    - name: Install dependencies (with retry)
      run: |
        for i in {1..3}; do
          echo "Attempt $i: Installing dependencies..."
          npm ci --prefer-offline --silent --no-audit --no-fund && break
          echo "Install failed. Waiting 30 seconds before retry..."
          sleep 30
        done

    # ESLintï¼ˆåŽ³æ ¼ï¼‰
    - name: ESLint Check
      run: npx eslint . --max-warnings=0 --cache --cache-location .eslintcache

    # TypeScriptåž‹ãƒã‚§ãƒƒã‚¯ï¼ˆåŽ³æ ¼ï¼‰
    - name: TypeScript Check
      run: npm run ci:type-check

    # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    - name: Build Check
      run: npm run ci:build

    - name: Push Check Summary
      run: |
        echo "## ðŸš€ Push Quick Check Results" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ESLint: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… TypeScript: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Build: Passed" >> $GITHUB_STEP_SUMMARY
