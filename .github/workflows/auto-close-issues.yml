name: Auto Close Issues on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - develop
      - main

jobs:
  close-issues:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
    - name: Close linked issues
      uses: actions/github-script@v7
      with:
        script: |
          // PRÊú¨Êñá„Åã„ÇâCloses„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊ§úÁ¥¢„Åó„Å¶IssueÁï™Âè∑„ÇíÊäΩÂá∫
          const prBody = context.payload.pull_request.body || '';
          const closeKeywords = ['closes', 'fixes', 'resolves'];
          const issues = [];
          
          closeKeywords.forEach(keyword => {
            const regex = new RegExp(`${keyword}\\s+#(\\d+)`, 'gi');
            let match;
            while ((match = regex.exec(prBody)) !== null) {
              issues.push(parseInt(match[1]));
            }
          });
          
          // ÈáçË§á„ÇíÈô§Âéª
          const uniqueIssues = [...new Set(issues)];
          
          console.log(`Found issues to close: ${uniqueIssues}`);
          
          // ÂêÑIssue„Çí„ÇØ„É≠„Éº„Ç∫
          for (const issueNumber of uniqueIssues) {
            try {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
              
              // „ÇØ„É≠„Éº„Ç∫„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚úÖ Issue automatically closed by PR #${context.payload.pull_request.number}

**Implementation completed:**
- Branch: \`${context.payload.pull_request.head.ref}\`
- Merged to: \`${context.payload.pull_request.base.ref}\`
- Commit: ${context.payload.pull_request.merge_commit_sha}

ü§ñ Auto-closed via GitHub Actions`
              });
              
              console.log(`Successfully closed issue #${issueNumber}`);
            } catch (error) {
              console.error(`Failed to close issue #${issueNumber}:`, error);
            }
          }