# Dev Container用Docker Compose設定
# VS Code Dev Containersから使用される設定ファイル
# コンテナ内で `supabase start` を実行してSupabaseを起動

services:
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
      args:
        VARIANT: "20-alpine"
    container_name: goal-diary-dev-container

    volumes:
      - ..:/app:cached
      - node_modules:/app/node_modules
      - /app/dist
      # Git設定の共有（ホストのGit設定を使用）
      - ~/.gitconfig:/root/.gitconfig:ro
      # SSH設定の共有（Git操作用）
      - ~/.ssh:/root/.ssh:ro
      # Docker-outside-of-Docker: ホストのDockerソケットをマウント
      - /var/run/docker.sock:/var/run/docker.sock
      # Claude Code認証情報の永続化
      - ~/.claude:/root/.claude
      # Serena設定の永続化
      - ~/.serena:/root/.serena

    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - CLAUDE_CONFIG_DIR=/root/.claude

    env_file:
      - ../.env

    # ホストネットワークモード（supabase startとの連携に必要）
    # 127.0.0.1がホストを指すようになり、supabaseコンテナにアクセス可能
    network_mode: host

    # entrypointを明示的に設定（Alpine Nodeイメージにdocker-entrypoint.shがないため）
    entrypoint: /bin/sh -c

    # Dev Container用のコマンド
    command: ["sleep infinity"]

    stdin_open: true
    tty: true

volumes:
  node_modules:
